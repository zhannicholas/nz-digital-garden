---
date: "2020-12-13T17:07:48+08:00"
title: "HTTP：网关、隧道和中继"
authors: Nicholas Zhan
categories:
  - HTTP
tags:
  - HTTP
draft: false
toc: true
---
Web上所有的资源都可以使用HTTP协议，并且其它应用和应用协议也可以利用HTTP来完成它们的任务。开发者可以将HTTP作为一个框架来使用其它协议并进行应用通信，例如：
* 用网关作为HTTP与其它协议和应用程序之间的接口。
* 用应用程序接口来实现Web上不同类型资源之间的相互通信。
* 用隧道在HTTP连接上发送非HTTP流量。
* 用中继逐跳转发数据。

## 网关
**网关（gateway）** 是一种在服务器之间充当中间实体的特殊服务器，通常用来将HTTP流量转换为其它协议流量。网关总是像源服务器一样接收请求，客户端可能并不知道自己在和一个网关通信。

### 客户端和服务端网关
Web网关在一侧使用HTTP协议，而在另一侧使用另一种协议。

网关可以用一个`/`分隔的客户端协议和服务端协议进行描述：`<client-protocol>/<server-protocol>`。例如，一个连接HTTP客户端与FTP服务器的网关就可以被称为HTTP/FTP网关。可以用术语 *客户端网关（clent-side gateway）* 和 *服务端网关（server-side gateway）* 来描述对话是在网关的哪一侧进行的：
* 客户端网关与客户端使用HTTP进行对话，而与服务器使用其它协议（`HTTP/*`）。
* 服务端网关与客户端使用其它协议进行对话，而与服务器使用HTTP协议（`*/HTTP`）。

### 协议网关
我们可以使用与将流量导向代理相同的方法来将流量导入网关。例如，显式配置浏览器使用网关、对流量进行透明拦截或将网关标记配置为反向代理。

#### HTTP/*：服务端Web网关
请求流入源服务器时，服务端Web网关会将客户端HTTP请求转换为其它协议。

#### HTTP/HTTPS：服务端安全网关
一个组织可以通过网关对所有的输入Web请求加密，以提供额外的隐私和安全性保护。客户端可以用普通的HTTP浏览Web内容，但是网关会自动加密用户的对话。

#### HTTPS/HTTP：客户端安全加速器网关
HTTPS/HTTP网关位于Web服务器之前，通常作为不可见的拦截网关或反向代理使用。它们接收安全的HTTPS流量，对安全流量进行解密，并向Web服务器发送普通的HTTP请求。这些网关通常包含专用的解密硬件，可以高效地解密安全流量，从而降低源服务器的负荷。但是，网关和源服务器之间发送的是未加密的流量，所以需要确保网关和源服务器之间的安全性。

### 资源网关
应用服务器是网关最常见的形式。应用服务器是服务端网关，它与客户端之间通过HTTP通信，并与服务端的某个应用程序相连。应用服务器可能会将HTTP请求通过**应用编程接口（Application Programming Interface, API）**传递给运行在服务端上的应用程序。

#### 通用网关接口
第一个流行的应用程序网关API就是**通用网关接口（Common Gateway Interface, CGI）**。CGI是一个标准接口集，Web服务器可以用它来装载程序以处理对特定URL的HTTP请求，收集程序的输出数据并将其放入HTTP响应中回送。

![Server gateway application mechanics](/images/computer_networks/http/server-gateway-application-mechanics.png)

上图展示了服务器与网关应用程序之间的基本交互机制。这个协议（请求、转交、响应）就是CGI模型的基本运行机制。

CGI应用程序是独立于服务器的，因此几乎可以采用任意语言实现。CGI的处理对用户是不可见的。客户端完全不知道服务器和CGI应用程序之间的转接过程，URL中出现字母`cgi`或可能的`?`是客户端发现使用了CGI应用程序的唯一线索。

CGI在服务器和众多资源类型之间提供了一个简单的对接方式，可以处理各种需要的转换。此外，他还能很好地保护服务器，防止一些扩展破坏服务器。但是这种分离会造成性能的损失，因为为每个CGI请求都创建一个新进程这一做法的代价是非常昂贵的。

#### 服务器扩展API
大多数流行的服务器都会为开发者提供一个或多个扩展API，这些扩展通常与服务器自身的架构有关系，开发者开一通过这些接口改变服务器的行为或定制实现某些需求。

## 隧道
**隧道（tunnel）** 是一种HTTP应用程序，当隧道建立后，它就会在两条连接之间对原始数据进行盲转发。HTTP隧道不会窥探数据，它通常用来在HTTP连接上传输非HTTP数据。利用HTTP隧道，用户可以通过HTTP应用程序访问使用非HTTP协议的应用程序。

### 隧道的建立
Web隧道是用HTTP的CONNECT方法建立起来的。CONNECT方法请求隧道网关创建一条通向任意目标服务器和端口的TCP连接，并对客户端和服务器之间的后续数据进行盲转发。

![Using CONNECT to establish an SSL tunnel](/images/computer_networks/http/Using-connect-to-establish-an-SSL-tunnel.png)

上图显示了使用CONNECT方法建立一条到网关的隧道的过程：
* 客户端发送一条CONNECT请求给隧道网关（图a），请求隧道打开一条TCP连接（这里打开的是一条标准SSL连接）。
* 建立网关与服务器之间的TCP连接（图b和图c）。
* 一旦TCP连接建立成功，网关就会发送一条`HTTP 200 Connection Established`响应给客户端（图d）。
* 隧道建立完成（图e）。客户端通过HTTP隧道发送的所有数据都会被直接转发给输出TCP连接，服务器发送的所有数据也会通过HTTP隧道转发给客户端。

## 中继
HTTP**中继（relay）** 是一个简单的HTTP代理，它没有完全遵循HTTP规范。中继做的事情很简单：建立连接，然后对字节进行盲转发。

## 参考资料
1. David Gourley, Brian Totty. *HTTP: The Definitive Guide*. O'Reilly Media, 2002.
