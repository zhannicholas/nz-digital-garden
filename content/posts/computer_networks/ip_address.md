---
date: "2020-12-13T15:44:47+08:00"
title: "IP寻址"
authors: Nicholas Zhan
categories:
  - Networks
tags:
  - Networks
draft: false
toc: true
---

## IP地址
IPv4采用的是32位地址，而Ipv6采用的是128位地址。Internet上的每台主机和路由器都有IP地址，<u>但一个IP地址并不真正指向一台主机或路由器，而是指向一个网络接口</u>。如果一台主机在两个网络上，那么它必须拥有两个IP地址。不过，大多数主机都在一个网络内，只有一个IP地址，但路由器有多个接口，从而有多个IP地址。

## IPv4
IPv4的书写格式是点分十进制表示法，将4个字节中的每个字节都写成一个0~255之间的整数，然后用`.`分隔。例如：32位的16进制地址80D00297可以写成128.208.2.151。

### 分类和特殊寻址
在1993年以前，IP地址被分为5类，这种分配被称为 **分类寻址**(classful addressing)。一个IPv4地址又32比特组成，其中包括一个网络号(唯一标识互联网中的某个子网)、一个主机号(唯一标识网络内的一台主机)。

![IP address formats](/images/computer_networks/fundamentals/IP-address-formats.png)

IP地址被划分为了上图中的A、B、C、D、E五个类别。今天，表明一个IP地址是否属于A、B或C类网络的标志位已不再使用。

有一些地址有着特俗的含义。全0这个地址(`0.0.0.0`)在主机启动的时候用，表示“这个网络”或“这个主机”。全1(`255.255.255.255`)这个地址表示指定网络中的所有主机，它允许在本地网络上进行广播。网络号为全0的地址表示本地网络的所有主机。主机号为全1并具有正确网络号的地址允许在该网络内进行广播。所有`127.xx.yy.zz`形式的地址保留，给本地环路测试用。

到了1990前后，按照当时IP地址的分配速度，到1996年前后就可能用完所有的IP地址，当时采取了3种解决方案：
1. 开发新的IP协议和寻址方案，结果有了现在的IPv6
2. 修改当前IP地址的分配方案，结果有了**CIDR**(Classless Inter Domain Routing, 无类域间路由)
3. 让未注册的计算机通过NAT的方式访问互联网

### CIDR
CIDR中已经没有IP地址分类的概念了，它允许使用任意长度的地址前缀，提高了IP地址空间的利用率。

每个32位的地址由高位的可变长网络和低位的主机两部分组成。同一个网络上的所有主机地址中的网络值是相同的，这意味着一个网络对应一块连续的IP地址空间，这块地址空间就被称为地址的 **前缀(prefix)**。前缀长度相当于网络部分中1的二进制掩码，例如前缀长度为24，其可以写成`255.255.255.0`或`/24`，这种写法被称为 **子网掩码(subnet mask)**。子网掩码可以和一个IP地址进行与运算，运算结果为该IP的网络部分。

将多个小前缀的地址块合并成一个大前缀的地址块的过程称为 **路由聚合(route aggregation)**。

CIDR的工作原理：当一个数据包到达时，路由器扫描路由表以便确定目的地是否在前缀的地址块内。这个时候有可能匹配到多个具有不同前缀的表项，这种情况下使用具有<u>最长前缀</u>的表项。

### NAT
**NAT(Network Address Translation)** 的思想是ISP为每个家庭或每个公司分配一个IP地址(或者尽可能少的分配IP地址)，用这个分配的IP地址来传输Internet流量。在网络内部，每台主机都有其唯一的IP地址，该地址用来进行网络内部路由。当一个数据包需要从网络内部去往其它网络时，必须进行地址转换，把其内部IP地址换成共享的那个IP地址。

有三类保留的IP地址可供内部网络主机使用：

| 范围                             | 数量     |
| -------------------------------- | -------- |
| 10.0.0.0 ~ 10.255.255.255/8      | 16777216 |
| 172.16.0.0 ~ 172.31.255.255/12   | 1048576  |
| 192.168.0.0 ~ 192.168.255.255/16 | 65536    |

最常用的NAT寻址算法的工作流程如下：
1. 当内部网络上的主机发送一个TCP或UDP包给网络外的主机时，路由器将数据包中的源IP地址和端口号保存为地址转换表中的一条记录
2. 路由器用自己的IP替换掉数据包中的源IP地址，用一个虚拟的端口号替换源端口，这个虚拟的端口号指向包含发送主机地址信息的那条记录
3. 路由器将修改了源IP地址和源端口的数据包转发给目标主机
4. 当路由器从外部主机接收到一个TCP或UDP包时，它使用包中的目的端口号访问地址转换表中的记录，并用记录的内容替换数据包中的目的地址和端口号，然后将修改后的数据包转发给内部网络中的主机

## IPv6
IPv6不仅解决了IPv4地址耗尽的问题，还做了很多的改进。IPv6地址由16个字节组成，16个字节被分成8组来书写，每一组4个16进制数字，组之间用冒号隔开。

## 参考资料
1. ANDREW S. TANENBAUM, DAVID J. WETHERALL. *Computer Networks, Fifth Edition*. Pearson, 2011.
