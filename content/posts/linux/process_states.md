---
author: Nicholas Zhan
title: "Linux 进程状态"
date: 2023-03-08T19:26:27+08:00
draft: false
language: zh
featured_image: ../../../static/images/linux/linux_process_state.svg
summary: 在这篇文章中，我们将学习 Linux 进程。我们会了解进程从创建到终止所经历地各种状态，以及这些状态之间的关系，进程是如何从一个状态进入另一个状态的。 最后，我们还会学习查看进程状态的两种命令。
categories:
  - Linux
tags:
  - Linux
---

在这篇文章中，我们将学习 Linux 进程。我们会了解进程从创建到终止所经历地各种状态，以及这些状态之间的关系，进程是如何从一个状态进入另一个状态的。 最后，我们还会学习查看进程状态的两种命令。


## Linux 进程状态

我们常说程序，程序其实是存储在磁盘上的一些代码指令，也可能是静态数据。程序运行起来就成了进程。进程是运行中的程序，状态是会变化的，有自己的生命周期，而程序本身是没有生命周期的。进程的一生可能经历以下五个状态：
* 运行中（RUNNING）或可运行（RUNNABLE），用字母 `R` 表示
* 不可中断睡眠（UNINTERRUPTIBLE_SLEEP），用字母 `D` 表示
* 可中断睡眠（UNTERRUPTIBLE_SLEEP），用字母 `S` 表示
* 已停止（STOPPED），用字母 `T` 表示
* 僵尸（ZOMBIE），用字母 `Z` 表示

很多 Linux 命令行工具并不会显示进程状态的完整单词，仅仅只会显示一个字母，比如 `S`。各个状态之间的流转情况如下：

![Process States](/images/linux/linux_process_state.svg)

### 运行中或可运行状态（R）

所有的 Linux 进程在被创建之后都会进入 `R` 状态。如果进程正在被 CPU 执行，它就是运行中状态，但如果 CPU 正在执行其它任务，而进程执行所需要的各种资源都已就绪，它就是可运行状态。
对进程来说，CPU 是十分宝贵的共享资源。为了保证系统内的进程都能被 CPU 执行，人们开发出了各种各样的进程调度算法，调度算法可能强制某个运行中的进程放弃 CPU，这个进程会被放入等待队列，状态也就从运行中变成了可运行。

### 不可中断睡眠状态（D）和可中断睡眠状态（S)

进程在运行过程中可能会因为进行 IO 操作，比如读写文件、发起网络请求等。这个时候，进程就会因为需要的资源得不到满足而无法继续被 CPU 执行下去。进程会在等待资源的时候放弃 CPU 进入睡眠状态，CPU 会被让给其它可运行的任务。
睡眠状态分为可中断睡眠和不可中断睡眠两种，二者的区别主要在于对待信号的方式：
* 处于可中断睡眠状态的进程能够在收到信号或等待的资源就绪后做出响应
* 处于不可中断睡眠状态的进程只能一直等待，直到资源可用，才会进入可运行状态。这个状态的进程不会对信号做出响应。


### 已停止状态（T）

对于一个处于运行中或可运行状态的进程，我们可以通过发送 `SIGSTOP` 或 `SIGTSTP` 信号让它进入停止状态。这两种信号的区别主要在于发送方式和进程收到它们之后的行为：
* `SIGSTOP` 是可编程的，例如：`kill -STOP`。进程在收到此信号之后不能装作没收到，必须进入停止状态
* `SIGTSTP` 是通过键盘 `CTRL + Z` 来发送的。进程在收到 `SIGTSTP` 信号之后，可以选择忽略，继续执行

处于停止状态的进程在收到 `SIGCONT` 后会重新进入 `R` 状态。

### 僵尸状态（Z）

进程在执行完成或者终止后，虽然会主动释放所有的数据结构和持有的资源，但是并不会清除自己在进程表中的条目，因为负责从进程表中清除子进程条目的是父进程。所以在子进程终止时，它会发送 `SIGCHLD` 信号给父进程，然后进入僵尸状态。在父进程将它从进程表中清理掉之前，这个进程就会一直处于僵尸状态。`SIGCHLD` 信号的作用就是通知父进程清理子进程在进程表中的条目。

## 通过命令查看进程状态

我们常用的 `ps` 和 `top` 都可以展示进程的状态信息。

### 使用 `top` 查看进程状态

`top` 命令的输出不仅包含非常详尽的系统性能数据，还有大量和进程有关的信息。其中，进程状态位于下半部分输出的 `S` 列：

![Process State in top Command](/images/linux/process_state_in_top.png)

`S` 列用单个字母表示进程的状态信息，相比起我们前面学习到的五种状态，这里稍有不同，`top` 命令的[文档](https://www.man7.org/linux/man-pages/man1/top.1.html)给出了所有字母所代表的具体含义：
* D：不可中断睡眠
* I：空转
* R：运行中
* S：睡眠中
* T：已停止，并且是通过控制信号停止的
* t：已停止，是被调式工具（debugger）临时停止的
* Z：僵尸

### 使用 `ps` 查看进程状态

`ps` 命令展示系统内进程的快照信息。要输出进程状态，我们需要带上 `a` 参数，例如：
```shell
$ ps a
    PID TTY      STAT   TIME COMMAND
   1139 ttyS0    Ss+    0:00 /sbin/agetty -o -p -- \u --keep-baud 115200,38400,9600 ttyS0 vt220
   1141 tty1     Ss+    0:00 /sbin/agetty -o -p -- \u --noclear tty1 linux
 391668 pts/1    R+     0:00 ps a
4156555 pts/1    Ss     0:00 -bash
```

进程状态显示在 `STAT` 列的第一个字母。上面的输出中显示，ID 为 391668 的进程正在运行，而其它几个进程都处于睡眠状态。
`ps` 命令输出的进程状态总共有[九种](https://man7.org/linux/man-pages/man1/ps.1.html#PROCESS_STATE_CODES)，其中有七种在前面讲 `top` 命令时已经提及了，剩余两种是 `X` 和 `W`，我们几乎碰不到。

和 `top` 命令相比，`ps` 的输出还包含进程的其它信息，例如 `+` 表示该进程位于前台进程组。



